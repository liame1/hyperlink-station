<html> 
  <head>
    <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.0.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-animation-component@^5.1.2/dist/aframe-animation-component.min.js"></script>
    
    <!-- Custom component to handle platform riding -->
    <script>
      // Component to make a platform carry the player
      AFRAME.registerComponent('platform-carrier', {
        schema: {
          playerSelector: {type: 'string', default: '#rig'}
        },
        
        init: function() {
          this.player = document.querySelector(this.data.playerSelector);
          this.isPlayerRiding = false;
          this.platformVelocity = new THREE.Vector3();
          this.lastPosition = new THREE.Vector3();
          this.currentPosition = new THREE.Vector3();
          this.yOffset = 0;
          
          // Store initial position
          this.el.object3D.getWorldPosition(this.lastPosition);
          this.currentPosition.copy(this.lastPosition);
          
          // Set up collision detection
          this.el.addEventListener('collide', this.checkCollision.bind(this));
        },
        
        checkCollision: function(event) {
          // Check if collision is with the player
          if (event.detail.body.el.id === 'rig') {
            // Calculate if player is on top of platform
            const playerPos = this.player.object3D.position;
            const platformPos = this.el.object3D.position;
            const platformHeight = this.el.getAttribute('geometry').height || 0.1;
            const platformTop = platformPos.y + (platformHeight / 2);
            
            // Check if player is standing on top (with some tolerance)
            const tolerance = 0.5; // Adjust based on your scene scale
            if (playerPos.y >= platformTop - tolerance) {
              if (!this.isPlayerRiding) {
                this.isPlayerRiding = true;
                // Calculate initial Y offset when player first steps on platform
                this.yOffset = playerPos.y - platformTop;
                console.log("Player started riding platform, yOffset:", this.yOffset);
              }
            }
          }
        },
        
        tick: function(time, delta) {
          // Update current position
          this.lastPosition.copy(this.currentPosition);
          this.el.object3D.getWorldPosition(this.currentPosition);
          
          // Calculate platform velocity
          this.platformVelocity.subVectors(this.currentPosition, this.lastPosition);
          
          // Check if player is still on platform
          if (this.isPlayerRiding) {
            const playerPos = this.player.object3D.position;
            const platformPos = this.el.object3D.position;
            const platformWidth = this.el.getAttribute('width') || 1;
            const platformDepth = this.el.getAttribute('depth') || 1;
            const platformHeight = this.el.getAttribute('height') || 0.1;
            
            // Check if player is still above platform bounds
            const halfWidth = platformWidth / 2;
            const halfDepth = platformDepth / 2;
            
            if (playerPos.x < platformPos.x - halfWidth || playerPos.x > platformPos.x + halfWidth ||
                playerPos.z < platformPos.z - halfDepth || playerPos.z > platformPos.z + halfDepth ||
                playerPos.y > platformPos.y + platformHeight + 3) { // Allow some vertical room
              this.isPlayerRiding = false;
              console.log("Player left platform");
            } else {
              // Move player with platform
              this.player.object3D.position.add(this.platformVelocity);
              
              // Maintain Y offset from platform top (so they don't sink in)
              const platformTop = platformPos.y + (platformHeight / 2);
              this.player.object3D.position.y = platformTop + this.yOffset;
            }
          }
        }
      });
    </script>
  </head>
  
  <body>
    <a-scene physics="gravity: -9.8;">
      <a-sky src="https://cdn.glitch.global/d728d810-f928-4a9d-8f49-85aeabfa83a5/AdobeStock_849984817.jpeg?v=1746163154753"></a-sky>
      
      <!-- Player rig with physics -->
      <a-entity id="rig" movement-controls="fly: false; constrainToNavMesh: false;" kinematic-body position="0 2 0">
        <a-entity camera position="0 1.6 0" look-controls="pointerLockEnabled: true"></a-entity>
      </a-entity>

      <!-- Ground -->
      <a-plane color="gray" position="0 -0.4 5" rotation="-90 0 0" width="100" height="100" static-body></a-plane>
      
      <!-- Moving platform 1 -->
      <a-box id="platform1" 
             color="blue" 
             position="-10 0 -15" 
             width="8" 
             depth="4" 
             height="0.5"
             static-body="type: kinematic" 
             platform-carrier
             animation="property: position; to: 10 0 -15; dir: alternate; dur: 5000; loop: true; easing: linear">
      </a-box>
      
      <!-- Moving platform 2 - vertical movement -->
      <a-box id="platform2" 
             color="green" 
             position="0 0 -5" 
             width="5" 
             depth="5" 
             height="0.5"
             static-body="type: kinematic" 
             platform-carrier
             animation="property: position; to: 0 5 -5; dir: alternate; dur: 4000; loop: true; easing: linear">
      </a-box>
      
      <!-- Moving platform 3 - diagonal movement -->
      <a-box id="platform3" 
             color="red" 
             position="-10 3 0" 
             width="5" 
             depth="5" 
             height="0.5"
             opacity="0.8"
             static-body="type: kinematic" 
             platform-carrier
             animation="property: position; to: 5 0 0; dir: alternate; dur: 5000; loop: true; easing: linear">
      </a-box>

      <!-- Display panel -->
      <a-plane position="-2.8 4 -8" scale="2 1 1" color="black"></a-plane>
      <a-text value="This is where iframe will exist" position="-4.3 4 -8"></a-text>
    </a-scene>
  </body>
</html>